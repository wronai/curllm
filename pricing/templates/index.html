<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Comparator - curllm</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè∑Ô∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>tailwind.config = { corePlugins: { preflight: true } }</script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-card {
            transition: all 0.3s ease;
        }
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-10">
            <div class="flex items-center justify-center gap-3 mb-4">
                <i data-lucide="shopping-cart" class="w-10 h-10 text-blue-600"></i>
                <h1 class="text-4xl font-bold text-gray-800">Price Comparator</h1>
            </div>
            <p class="text-gray-600 text-lg">Por√≥wnuj ceny i parametry produkt√≥w z wielu sklep√≥w internetowych</p>
            <p class="text-gray-500 text-sm mt-2">Powered by <span class="font-mono text-blue-600">curllm</span></p>
        </header>

        <!-- Main Form -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <form id="compareForm" class="space-y-6">
                <!-- URLs Section -->
                <div>
                    <label class="flex items-center gap-2 text-lg font-semibold text-gray-700 mb-3">
                        <i data-lucide="link" class="w-5 h-5"></i>
                        Adresy URL produkt√≥w (jeden URL na liniƒô)
                    </label>
                    <textarea id="urlsTextarea" rows="8"
                              placeholder="Wklej URL-e produkt√≥w, jeden na liniƒô...

https://allegro.pl/oferta/produkt-1
https://sklep.pl/produkt-2
https://morele.net/produkt-3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-y font-mono text-sm"></textarea>
                    <p class="text-gray-500 text-sm mt-2">
                        <span id="urlCount">0</span> URL-i do przetworzenia
                    </p>
                </div>

                <!-- Extraction Prompt -->
                <div>
                    <label class="flex items-center gap-2 text-lg font-semibold text-gray-700 mb-3">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                        Prompt ekstrakcji (dla ka≈ºdego URL)
                    </label>
                    <textarea id="extractionPrompt" rows="4" 
                              placeholder="Opisz jakie dane chcesz wyciƒÖgnƒÖƒá z ka≈ºdej strony produktowej...

Przyk≈Çad: WyciƒÖgnij nazwƒô produktu, cenƒô, specyfikacje techniczne, dostƒôpno≈õƒá i oceny u≈ºytkownik√≥w."
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-y">WyciƒÖgnij nastƒôpujƒÖce informacje o produkcie:
- Nazwa produktu
- Cena (z walutƒÖ)
- Specyfikacje techniczne (parametry)
- Dostƒôpno≈õƒá
- Ocena u≈ºytkownik√≥w
- G≈Ç√≥wne cechy/zalety</textarea>
                </div>

                <!-- Comparison Prompt -->
                <div>
                    <label class="flex items-center gap-2 text-lg font-semibold text-gray-700 mb-3">
                        <i data-lucide="git-compare" class="w-5 h-5"></i>
                        Prompt por√≥wnawczy (analiza wszystkich wynik√≥w)
                    </label>
                    <textarea id="comparisonPrompt" rows="4"
                              placeholder="Opisz jak chcesz por√≥wnaƒá zebrane dane...

Przyk≈Çad: Por√≥wnaj ceny i parametry produkt√≥w, wska≈º najlepszƒÖ ofertƒô cenowƒÖ i najlepszy stosunek jako≈õci do ceny."
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-y">Por√≥wnaj wszystkie znalezione produkty. Przeanalizuj:
1. R√≥≈ºnice w cenach miƒôdzy sklepami
2. R√≥≈ºnice w specyfikacjach/parametrach
3. Stosunek jako≈õci do ceny
4. Wska≈º najlepszƒÖ ofertƒô cenowƒÖ
5. Wska≈º najlepszy produkt pod wzglƒôdem parametr√≥w
6. Daj ko≈ÑcowƒÖ rekomendacjƒô zakupowƒÖ</textarea>
                </div>

                <!-- Options -->
                <div class="flex items-center gap-6">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="stealthMode" checked 
                               class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-gray-700">Tryb stealth (omijanie blokad)</span>
                    </label>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn"
                        class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-lg font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-3">
                    <i data-lucide="search" class="w-6 h-6"></i>
                    Por√≥wnaj produkty
                </button>
            </form>
        </div>

        <!-- Loading State with Logs -->
        <div id="loading" class="hidden py-8">
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="loader"></div>
                    <div>
                        <p class="text-gray-800 text-lg font-semibold" id="loadingText">Pobieranie danych ze sklep√≥w...</p>
                        <p class="text-gray-500 text-sm" id="loadingProgress">0 / 0 URL-i przetworzonych</p>
                    </div>
                </div>
                <!-- Progress bar -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <!-- Real-time logs -->
                <div class="bg-gray-900 rounded-xl p-4 max-h-80 overflow-y-auto" id="logContainer">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="terminal" class="w-4 h-4 text-green-400"></i>
                        <span class="text-green-400 text-sm font-mono">Logi ekstrakcji</span>
                    </div>
                    <div id="logContent" class="font-mono text-xs space-y-1">
                        <!-- Logs will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden space-y-8 fade-in">
            <!-- Extraction Results -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="flex items-center gap-3 text-2xl font-bold text-gray-800">
                        <i data-lucide="database" class="w-7 h-7 text-green-600"></i>
                        Wyniki ekstrakcji z poszczeg√≥lnych sklep√≥w
                    </h2>
                    <button onclick="rerunComparison()" id="rerunComparisonBtn"
                            class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Pon√≥w analizƒô por√≥wnawczƒÖ
                    </button>
                </div>
                <div id="extractionResults" class="space-y-4">
                    <!-- Results will be inserted here -->
                </div>
            </div>

            <!-- Comparison Analysis -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="flex items-center gap-3 text-2xl font-bold text-gray-800 mb-6">
                    <i data-lucide="bar-chart-3" class="w-7 h-7 text-blue-600"></i>
                    Analiza por√≥wnawcza
                </h2>
                <div id="comparisonAnalysis" class="prose max-w-none">
                    <!-- Analysis will be inserted here -->
                </div>
            </div>

            <!-- Summary Table -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="flex items-center gap-3 text-2xl font-bold text-gray-800 mb-6">
                    <i data-lucide="table" class="w-7 h-7 text-purple-600"></i>
                    Tabela por√≥wnawcza
                </h2>
                <div id="summaryTable" class="overflow-x-auto">
                    <!-- Table will be inserted here -->
                </div>
            </div>

            <!-- Best Price Banner -->
            <div id="bestPriceBanner" class="hidden bg-gradient-to-r from-green-500 to-emerald-500 rounded-2xl shadow-xl p-6 text-white">
                <div class="flex items-center gap-4">
                    <i data-lucide="trophy" class="w-12 h-12"></i>
                    <div>
                        <h3 class="text-xl font-bold">Najlepsza cena!</h3>
                        <p id="bestPriceInfo" class="text-lg opacity-90"></p>
                        <a id="bestPriceLink" href="#" target="_blank" 
                           class="inline-flex items-center gap-2 mt-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                            Przejd≈∫ do oferty
                            <i data-lucide="external-link" class="w-4 h-4"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-2xl p-8 text-center">
            <i data-lucide="alert-circle" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
            <h3 class="text-xl font-bold text-red-700 mb-2">WystƒÖpi≈Ç b≈ÇƒÖd</h3>
            <p id="errorMessage" class="text-red-600"></p>
            <button onclick="resetForm()" class="mt-4 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                Spr√≥buj ponownie
            </button>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        function getUrlsFromTextarea() {
            const textarea = document.getElementById('urlsTextarea');
            return textarea.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line && line.startsWith('http'));
        }

        function updateUrlCount() {
            const urls = getUrlsFromTextarea();
            document.getElementById('urlCount').textContent = urls.length;
        }

        // Update count on textarea input
        document.getElementById('urlsTextarea').addEventListener('input', updateUrlCount);

        let totalUrls = 0;
        let processedUrls = 0;

        function resetForm() {
            document.getElementById('results').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('logContent').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            totalUrls = 0;
            processedUrls = 0;
        }

        function showLoading(text, urlCount) {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loadingText').textContent = text;
            document.getElementById('results').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('logContent').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            totalUrls = urlCount || 0;
            processedUrls = 0;
            updateProgress();
            addLog('info', `Rozpoczynam ekstrakcjƒô z ${totalUrls} URL-i...`);
            lucide.createIcons();
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
        }

        function updateProgress() {
            const percent = totalUrls > 0 ? Math.round((processedUrls / totalUrls) * 100) : 0;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('loadingProgress').textContent = `${processedUrls} / ${totalUrls} URL-i przetworzonych`;
        }

        function addLog(type, message) {
            const logContent = document.getElementById('logContent');
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString('pl-PL');
            
            const colors = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400',
                'progress': 'text-gray-400'
            };
            
            const icons = {
                'info': '‚Üí',
                'success': '‚úì',
                'error': '‚úó',
                'warning': '‚ö†',
                'progress': '‚Ä¢'
            };
            
            const div = document.createElement('div');
            div.className = `${colors[type] || 'text-gray-300'}`;
            div.innerHTML = `<span class="text-gray-500">[${time}]</span> ${icons[type] || '‚Ä¢'} ${message}`;
            logContent.appendChild(div);
            
            // Auto-scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showError(message) {
            addLog('error', message);
            hideLoading();
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // Store all results globally for retry functionality
        let allExtractionResults = [];
        let currentExtractionPrompt = '';
        
        function renderExtractionResults(results) {
            const container = document.getElementById('extractionResults');
            container.innerHTML = '';
            allExtractionResults = results;

            results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = `result-card border rounded-xl p-6 ${result.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`;
                card.id = `result-card-${index}`;
                
                const icon = result.success ? 'check-circle' : 'x-circle';
                const iconColor = result.success ? 'text-green-600' : 'text-red-600';
                
                let dataHtml = '';
                if (result.success && result.data) {
                    dataHtml = `
                        <details class="mt-4">
                            <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-medium">
                                Poka≈º szczeg√≥≈Çy danych
                            </summary>
                            <pre class="mt-3 p-4 bg-gray-800 text-green-400 rounded-lg overflow-x-auto text-sm">${JSON.stringify(result.data, null, 2)}</pre>
                        </details>
                    `;
                } else if (result.error) {
                    dataHtml = `
                        <p class="text-red-600 mt-2 mb-3">${result.error}</p>
                        <div class="retry-section bg-white rounded-lg p-3 border border-gray-200">
                            <div class="flex flex-col gap-2">
                                <label class="text-sm font-medium text-gray-700">Edytuj URL i pon√≥w:</label>
                                <input type="url" id="retry-url-${index}" 
                                       value="${result.url}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500">
                                <div class="flex gap-2">
                                    <button onclick="retryExtraction(${index})" 
                                            class="flex-1 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                        Pon√≥w
                                    </button>
                                    <button onclick="smartRetryExtraction(${index})" 
                                            class="flex-1 px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2"
                                            title="Automatycznie znajdzie odpowiedniƒÖ stronƒô przez wyszukiwarkƒô sklepu">
                                        <i data-lucide="wand-2" class="w-4 h-4"></i>
                                        Smart
                                    </button>
                                    <button onclick="removeResult(${index})" 
                                            class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-300 transition">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500">üí° "Smart" automatycznie wyszuka produkty na stronie sklepu</p>
                            </div>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="flex items-start gap-4">
                        <i data-lucide="${icon}" class="w-6 h-6 ${iconColor} flex-shrink-0 mt-1"></i>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${result.store_name}</h4>
                            <a href="${result.url}" target="_blank" class="text-blue-600 hover:underline text-sm break-all">${result.url}</a>
                            ${dataHtml}
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });

            lucide.createIcons();
        }
        
        async function retryExtraction(index) {
            const urlInput = document.getElementById(`retry-url-${index}`);
            const newUrl = urlInput.value.trim();
            
            if (!newUrl || !newUrl.startsWith('http')) {
                alert('Proszƒô podaƒá prawid≈Çowy URL');
                return;
            }
            
            const card = document.getElementById(`result-card-${index}`);
            card.innerHTML = `
                <div class="flex items-center gap-4 p-4">
                    <div class="loader" style="width: 24px; height: 24px; border-width: 3px;"></div>
                    <span class="text-gray-600">Pobieranie danych z ${new URL(newUrl).hostname}...</span>
                </div>
            `;
            
            try {
                const extractionPrompt = document.getElementById('extractionPrompt').value.trim();
                const stealth = document.getElementById('stealthMode').checked;
                
                const response = await fetch('/api/extract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: newUrl,
                        prompt: extractionPrompt,
                        stealth: stealth
                    })
                });
                
                const result = await response.json();
                
                // Update the result in our array
                allExtractionResults[index] = result;
                
                // Re-render just this card
                renderSingleResult(index, result);
                
            } catch (error) {
                allExtractionResults[index] = {
                    url: newUrl,
                    store_name: new URL(newUrl).hostname,
                    success: false,
                    error: error.message
                };
                renderSingleResult(index, allExtractionResults[index]);
            }
        }
        
        async function smartRetryExtraction(index) {
            const urlInput = document.getElementById(`retry-url-${index}`);
            const newUrl = urlInput.value.trim();
            
            if (!newUrl || !newUrl.startsWith('http')) {
                alert('Proszƒô podaƒá prawid≈Çowy URL');
                return;
            }
            
            const card = document.getElementById(`result-card-${index}`);
            card.innerHTML = `
                <div class="flex items-center gap-4 p-4">
                    <div class="loader" style="width: 24px; height: 24px; border-width: 3px;"></div>
                    <div>
                        <span class="text-gray-600">üîç Smart search: ${new URL(newUrl).hostname}...</span>
                        <p class="text-xs text-gray-500">Szukam odpowiedniej strony z produktami...</p>
                    </div>
                </div>
            `;
            
            try {
                const extractionPrompt = document.getElementById('extractionPrompt').value.trim();
                const stealth = document.getElementById('stealthMode').checked;
                
                const response = await fetch('/api/smart-extract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: newUrl,
                        prompt: extractionPrompt,
                        stealth: stealth
                    })
                });
                
                const result = await response.json();
                
                // Update the result in our array
                allExtractionResults[index] = result;
                
                // Show resolution info if available
                if (result.url_resolution && result.url_resolution.resolved_url !== newUrl) {
                    console.log('URL resolved:', result.url_resolution);
                }
                
                // Re-render just this card
                renderSingleResult(index, result);
                
            } catch (error) {
                allExtractionResults[index] = {
                    url: newUrl,
                    store_name: new URL(newUrl).hostname,
                    success: false,
                    error: error.message
                };
                renderSingleResult(index, allExtractionResults[index]);
            }
        }
        
        function renderSingleResult(index, result) {
            const card = document.getElementById(`result-card-${index}`);
            card.className = `result-card border rounded-xl p-6 ${result.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`;
            
            const icon = result.success ? 'check-circle' : 'x-circle';
            const iconColor = result.success ? 'text-green-600' : 'text-red-600';
            
            let dataHtml = '';
            if (result.success && result.data) {
                dataHtml = `
                    <details class="mt-4">
                        <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-medium">
                            Poka≈º szczeg√≥≈Çy danych
                        </summary>
                        <pre class="mt-3 p-4 bg-gray-800 text-green-400 rounded-lg overflow-x-auto text-sm">${JSON.stringify(result.data, null, 2)}</pre>
                    </details>
                `;
            } else if (result.error) {
                dataHtml = `
                    <p class="text-red-600 mt-2 mb-3">${result.error}</p>
                    <div class="retry-section bg-white rounded-lg p-3 border border-gray-200">
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-gray-700">Edytuj URL i pon√≥w:</label>
                            <input type="url" id="retry-url-${index}" 
                                   value="${result.url}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500">
                            <div class="flex gap-2">
                                <button onclick="retryExtraction(${index})" 
                                        class="flex-1 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Pon√≥w
                                </button>
                                <button onclick="smartRetryExtraction(${index})" 
                                        class="flex-1 px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2"
                                        title="Automatycznie znajdzie odpowiedniƒÖ stronƒô przez wyszukiwarkƒô sklepu">
                                    <i data-lucide="wand-2" class="w-4 h-4"></i>
                                    Smart
                                </button>
                                <button onclick="removeResult(${index})" 
                                        class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-300 transition">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500">üí° "Smart" automatycznie wyszuka produkty na stronie sklepu</p>
                        </div>
                    </div>
                `;
            }
            
            // Show URL resolution info if available
            let resolutionHtml = '';
            if (result.url_resolution && result.url_resolution.resolution_method !== 'none') {
                const r = result.url_resolution;
                if (r.resolved_url !== r.original_url) {
                    resolutionHtml = `
                        <div class="mt-2 p-2 bg-purple-50 rounded-lg text-xs">
                            <span class="text-purple-600 font-medium">üîç URL rozwiƒÖzany:</span>
                            <span class="text-gray-600">${r.resolution_method}</span>
                        </div>
                    `;
                }
            }

            card.innerHTML = `
                <div class="flex items-start gap-4">
                    <i data-lucide="${icon}" class="w-6 h-6 ${iconColor} flex-shrink-0 mt-1"></i>
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">${result.store_name}</h4>
                        <a href="${result.url}" target="_blank" class="text-blue-600 hover:underline text-sm break-all">${result.url}</a>
                        ${resolutionHtml}
                        ${dataHtml}
                    </div>
                </div>
            `;
            
            lucide.createIcons();
        }
        
        function removeResult(index) {
            allExtractionResults.splice(index, 1);
            renderExtractionResults(allExtractionResults);
        }
        
        async function rerunComparison() {
            const btn = document.getElementById('rerunComparisonBtn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<div class="loader" style="width: 16px; height: 16px; border-width: 2px;"></div> Analizujƒô...';
            btn.disabled = true;
            
            // Filter only successful results
            const successfulResults = allExtractionResults.filter(r => r.success && r.data);
            
            if (successfulResults.length === 0) {
                alert('Brak udanych ekstrakcji do por√≥wnania. Popraw b≈Çƒôdne URL-e i spr√≥buj ponownie.');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
                return;
            }
            
            try {
                const comparisonPrompt = document.getElementById('comparisonPrompt').value.trim() || 
                    'Por√≥wnaj ceny i parametry produkt√≥w ze wszystkich sklep√≥w.';
                
                const response = await fetch('/api/recompare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        extraction_results: successfulResults,
                        comparison_prompt: comparisonPrompt
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.comparison) {
                    if (data.comparison.analysis) {
                        renderComparisonAnalysis(data.comparison.analysis);
                    }
                    if (data.comparison.summary_table) {
                        renderSummaryTable(data.comparison.summary_table);
                    }
                    if (data.comparison.best_price) {
                        renderBestPrice(data.comparison.best_price);
                    }
                }
                
            } catch (error) {
                alert('B≈ÇƒÖd podczas analizy: ' + error.message);
            }
            
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            lucide.createIcons();
        }

        function renderComparisonAnalysis(analysis) {
            const container = document.getElementById('comparisonAnalysis');
            // Convert newlines to paragraphs
            const paragraphs = analysis.split('\n').filter(p => p.trim());
            container.innerHTML = paragraphs.map(p => `<p class="mb-3 text-gray-700">${p}</p>`).join('');
        }

        function renderSummaryTable(data) {
            const container = document.getElementById('summaryTable');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Brak danych do wy≈õwietlenia tabeli por√≥wnawczej.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'w-full border-collapse';

            // Headers
            const headers = ['Sklep', 'Produkt', 'Cena', 'Dostƒôpno≈õƒá', 'Ocena', 'G≈Ç√≥wne cechy'];
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr class="bg-gray-100">
                    ${headers.map(h => `<th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">${h}</th>`).join('')}
                </tr>
            `;
            table.appendChild(thead);

            // Body
            const tbody = document.createElement('tbody');
            data.forEach((row, index) => {
                const features = Array.isArray(row.key_features) ? row.key_features.join(', ') : (row.key_features || '-');
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                tr.innerHTML = `
                    <td class="px-4 py-3 border-b">
                        <a href="${row.url || '#'}" target="_blank" class="text-blue-600 hover:underline font-medium">${row.store || '-'}</a>
                    </td>
                    <td class="px-4 py-3 border-b">${row.product_name || '-'}</td>
                    <td class="px-4 py-3 border-b font-bold text-green-700">${row.price || '-'} ${row.currency || ''}</td>
                    <td class="px-4 py-3 border-b">${row.availability || '-'}</td>
                    <td class="px-4 py-3 border-b">${row.rating || '-'}</td>
                    <td class="px-4 py-3 border-b text-sm text-gray-600">${features}</td>
                `;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            container.innerHTML = '';
            container.appendChild(table);
        }

        function renderBestPrice(bestPrice) {
            const banner = document.getElementById('bestPriceBanner');
            const info = document.getElementById('bestPriceInfo');
            const link = document.getElementById('bestPriceLink');

            if (bestPrice && bestPrice.store && bestPrice.price) {
                info.textContent = `${bestPrice.store}: ${bestPrice.price}`;
                if (bestPrice.url) {
                    link.href = bestPrice.url;
                    link.classList.remove('hidden');
                } else {
                    link.classList.add('hidden');
                }
                banner.classList.remove('hidden');
                lucide.createIcons();
            } else {
                banner.classList.add('hidden');
            }
        }

        document.getElementById('compareForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Collect URLs from textarea
            const urls = getUrlsFromTextarea();

            if (urls.length === 0) {
                showError('Proszƒô podaƒá przynajmniej jeden URL produktu (jeden URL na liniƒô).');
                return;
            }

            const extractionPrompt = document.getElementById('extractionPrompt').value.trim();
            const comparisonPrompt = document.getElementById('comparisonPrompt').value.trim();
            const stealth = document.getElementById('stealthMode').checked;

            if (!extractionPrompt) {
                showError('Proszƒô podaƒá prompt ekstrakcji.');
                return;
            }

            showLoading(`Pobieranie danych z ${urls.length} sklep√≥w...`, urls.length);

            // Log each URL we're about to process
            urls.forEach((url, i) => {
                const hostname = new URL(url).hostname;
                addLog('progress', `[${i+1}/${urls.length}] Zakolejkowano: ${hostname}`);
            });

            try {
                // Use streaming API
                const response = await fetch('/api/compare/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        urls,
                        extraction_prompt: extractionPrompt,
                        comparison_prompt: comparisonPrompt || 'Por√≥wnaj ceny i parametry produkt√≥w ze wszystkich sklep√≥w.',
                        stealth
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Request failed');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finalData = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const eventData = JSON.parse(line.slice(6));
                                
                                if (eventData.type === 'log') {
                                    addLog(eventData.level || 'info', eventData.message);
                                } else if (eventData.type === 'progress') {
                                    processedUrls = eventData.processed;
                                    updateProgress();
                                    addLog(eventData.success ? 'success' : 'error', 
                                           `${eventData.store}: ${eventData.success ? 'OK' : eventData.error}`);
                                } else if (eventData.type === 'stage') {
                                    addLog('info', eventData.message);
                                } else if (eventData.type === 'result') {
                                    finalData = eventData.data;
                                }
                            } catch (e) {
                                // Skip invalid JSON
                            }
                        }
                    }
                }

                if (!finalData) {
                    throw new Error('No result received from server');
                }

                addLog('success', 'Ekstrakcja zako≈Ñczona pomy≈õlnie!');
                hideLoading();

                // Render results
                if (finalData.extraction_results) {
                    renderExtractionResults(finalData.extraction_results);
                }

                if (finalData.comparison) {
                    if (finalData.comparison.analysis) {
                        renderComparisonAnalysis(finalData.comparison.analysis);
                    }
                    if (finalData.comparison.summary_table) {
                        renderSummaryTable(finalData.comparison.summary_table);
                    }
                    if (finalData.comparison.best_price) {
                        renderBestPrice(finalData.comparison.best_price);
                    }
                }

                document.getElementById('results').classList.remove('hidden');

            } catch (error) {
                showError(error.message || 'WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd.');
            }
        });

        // Initialize
        updateUrlCount();
    </script>
</body>
</html>
